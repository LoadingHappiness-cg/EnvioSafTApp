<Window x:Class="EnvioSafTApp.MainWindow"
        xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:converters="clr-namespace:EnvioSafTApp.Converters"
        Title="EnviaSaft"
        Height="860"
        Width="1360"
        WindowStartupLocation="CenterScreen"
        MinWidth="1220"
        MinHeight="760">
    <Window.Resources>
        <converters:TickerTypeToColorConverter x:Key="TickerTypeToColorConverter"/>
        <converters:TickerTypeToIconConverter x:Key="TickerTypeToIconConverter"/>
        <converters:InverseBooleanConverter x:Key="InverseBooleanConverter"/>
        <converters:SaftSeverityToColorConverter x:Key="SaftSeverityToColorConverter"/>
    </Window.Resources>

    <Grid Classes="WindowRootSurface">
        <Grid.RowDefinitions>
            <RowDefinition Height="86"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="44"/>
        </Grid.RowDefinitions>

        <Border Grid.Row="0" Classes="TopGlassBar" Margin="14,14,14,0" Padding="18,12">
            <Grid ColumnDefinitions="Auto,*,Auto,Auto" ColumnSpacing="12">
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Spacing="12">
                    <Border Classes="BrandMarkWrap" Padding="10,6">
                        <Image Source="avares://EnvioSafTApp/EnviaSaft.png" Height="38"/>
                    </Border>
                    <StackPanel Spacing="2" VerticalAlignment="Center">
                        <TextBlock Text="Envio SAF-T AT" Classes="TopTitleText"/>
                        <TextBlock Text="Aplicação para envio seguro e validação SAF-T" Classes="TopSubtitleText"/>
                    </StackPanel>
                </StackPanel>

                <Border Grid.Column="2" Classes="VersionChip" VerticalAlignment="Center" Margin="0,0,2,0">
                    <TextBlock Text="{Binding AppVersion}" Classes="VersionText"/>
                </Border>

                <Button Grid.Column="3"
                        Content="ENVIAR"
                        Classes="ModernSendButtonStyle"
                        Command="{Binding EnviarCommand}"
                        VerticalAlignment="Center"
                        IsEnabled="{Binding IsSending, Converter={StaticResource InverseBooleanConverter}}"/>
            </Grid>
        </Border>

        <Border Grid.Row="1" Classes="AppShell" Margin="14,12,14,10" Padding="10">
            <TabControl x:Name="RightTabControl"
                        Classes="MacMainTabs"
                        TabStripPlacement="Left"
                        SelectionChanged="RightTabControl_SelectionChanged"
                        SelectedIndex="{Binding SelectedTabIndex, Mode=TwoWay}">

                <TabItem x:Name="PreValidacaoTab" Classes="SidebarNavItem">
                    <TabItem.Header>
                        <TextBlock Text="Pré-validação"/>
                    </TabItem.Header>
                    <Grid ColumnDefinitions="1.6*,0.9*" ColumnSpacing="14">
                        <ScrollViewer Grid.Column="0" VerticalScrollBarVisibility="Auto">
                            <StackPanel Spacing="12">
                                <Border Classes="ModernGroupBoxStyle">
                                    <StackPanel Margin="6" Spacing="10">
                                        <TextBlock Text="Dados do envio" Classes="SectionTitle"/>
                                        <Grid ColumnDefinitions="*,*,1.5*" ColumnSpacing="10">
                                            <StackPanel Grid.Column="0" Spacing="4">
                                                <TextBlock Text="Ano *" Classes="FieldLabel"/>
                                                <TextBox x:Name="AnoTextBox" Text="{Binding Ano, UpdateSourceTrigger=PropertyChanged}" Classes="ModernTextBoxStyle" Height="36"/>
                                            </StackPanel>
                                            <StackPanel Grid.Column="1" Spacing="4">
                                                <TextBlock Text="Mês *" Classes="FieldLabel"/>
                                                <TextBox x:Name="MesTextBox" Text="{Binding Mes, UpdateSourceTrigger=PropertyChanged}" Classes="ModernTextBoxStyle" Height="36"/>
                                            </StackPanel>
                                            <StackPanel Grid.Column="2" Spacing="4">
                                                <TextBlock Text="Operação *" Classes="FieldLabel"/>
                                                <ComboBox x:Name="OperacaoComboBox"
                                                          SelectedValue="{Binding Operacao}"
                                                          SelectedValueBinding="{Binding Content}"
                                                          Classes="ModernComboBoxStyle"
                                                          Height="36">
                                                    <ComboBoxItem Content="validar"/>
                                                    <ComboBoxItem Content="enviar" IsSelected="True"/>
                                                </ComboBox>
                                            </StackPanel>
                                        </Grid>

                                        <Grid ColumnDefinitions="*,*" ColumnSpacing="10">
                                            <StackPanel Grid.Column="0" Spacing="4">
                                                <TextBlock Text="NIF *" Classes="FieldLabel"/>
                                                <TextBox x:Name="NifTextBox" Text="{Binding Nif, UpdateSourceTrigger=PropertyChanged}" Classes="ModernTextBoxStyle" Height="36"/>
                                            </StackPanel>
                                            <StackPanel Grid.Column="1" Spacing="4">
                                                <TextBlock Text="Password *" Classes="FieldLabel"/>
                                                <TextBox x:Name="PasswordBox" Text="{Binding Password, UpdateSourceTrigger=PropertyChanged}" Classes="ModernPasswordBoxStyle" PasswordChar="●" Height="36"/>
                                            </StackPanel>
                                        </Grid>
                                    </StackPanel>
                                </Border>

                                <Border Classes="ModernGroupBoxStyle">
                                    <StackPanel Margin="6" Spacing="10">
                                        <TextBlock Text="Ficheiro SAF-T" Classes="SectionTitle"/>
                                        <TextBlock Text="Ficheiro *" Classes="FieldLabel"/>
                                        <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                                            <TextBox x:Name="FicheiroTextBox" Text="{Binding FicheiroSafT, UpdateSourceTrigger=PropertyChanged}" Classes="ModernTextBoxStyle" Height="38" Grid.Column="0"/>
                                            <Button Content="..." Classes="ModernIconButtonStyle" Width="40" Height="38" Grid.Column="1" FontSize="16" Command="{Binding BrowseFileCommand}"/>
                                        </Grid>

                                        <StackPanel Orientation="Horizontal" Spacing="24" Margin="0,2,0,0">
                                            <CheckBox x:Name="TesteCheckBox" IsChecked="{Binding IsTeste}" Content="Envio de Teste" VerticalAlignment="Center"/>
                                            <CheckBox x:Name="AutoFaturacaoCheckBox" IsChecked="{Binding IsAutoFaturacao}" Content="Autofaturação" VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </StackPanel>
                                </Border>

                                <Border Classes="ModernGroupBoxStyle">
                                    <StackPanel Margin="6" Spacing="8">
                                        <TextBlock Text="Opções avançadas" Classes="SectionTitle"/>

                                        <TextBlock Text="Password do Arquivo" Classes="FieldLabel"/>
                                        <TextBox x:Name="ArquivoPasswordBox" Text="{Binding ArquivoPassword, UpdateSourceTrigger=PropertyChanged}" Classes="ModernPasswordBoxStyle" PasswordChar="●" Height="36"/>

                                        <TextBlock Text="NIF Emitente" Classes="FieldLabel"/>
                                        <TextBox x:Name="NifEmitenteTextBox" Text="{Binding NifEmitente, UpdateSourceTrigger=PropertyChanged}" Classes="ModernTextBoxStyle" Height="36"/>

                                        <TextBlock Text="Ficheiro de Retorno" Classes="FieldLabel"/>
                                        <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8">
                                            <TextBox x:Name="OutputTextBox" Text="{Binding OutputFile, UpdateSourceTrigger=PropertyChanged}" Classes="ModernTextBoxStyle" Height="36" Grid.Column="0"/>
                                            <Button Content="..." Classes="ModernIconButtonStyle" Width="36" Height="36" Grid.Column="1" FontSize="14" Command="{Binding BrowseOutputFileCommand}"/>
                                        </Grid>

                                        <TextBlock Text="Memória (ex: -Xmx512m)" Classes="FieldLabel"/>
                                        <TextBox x:Name="MemoriaTextBox" Text="{Binding Memoria, UpdateSourceTrigger=PropertyChanged}" Classes="ModernTextBoxStyle" Height="36"/>

                                        <TextBlock Text="Etiquetas (separadas por vírgula)" Classes="FieldLabel"/>
                                        <TextBox x:Name="EtiquetasTextBox" Text="{Binding Etiquetas, UpdateSourceTrigger=PropertyChanged}" Classes="ModernTextBoxStyle" Height="36"/>
                                    </StackPanel>
                                </Border>
                            </StackPanel>
                        </ScrollViewer>

                        <ScrollViewer Grid.Column="1" VerticalScrollBarVisibility="Auto">
                            <StackPanel Spacing="12">
                                <Border Classes="ModernGroupBoxStyle">
                                    <StackPanel Margin="6" Spacing="8">
                                        <TextBlock Text="Pré-verificações do ambiente" Classes="SectionTitle"/>
                                        <TextBlock Text="{Binding PreflightStatusText}" Classes="AccentSummaryText"/>

                                        <ListBox x:Name="PreflightListView"
                                                 ItemsSource="{Binding PreflightChecks}"
                                                 BorderThickness="0"
                                                 Background="Transparent"
                                                 ScrollViewer.VerticalScrollBarVisibility="Disabled"
                                                 ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                                            <ListBox.ItemTemplate>
                                                <DataTemplate>
                                                    <Border Classes="CheckItemCard">
                                                        <StackPanel Spacing="4">
                                                            <TextBlock Text="{Binding Nome}" FontWeight="SemiBold"/>
                                                            <TextBlock Text="{Binding Detalhes}" TextWrapping="Wrap"/>
                                                        </StackPanel>
                                                    </Border>
                                                </DataTemplate>
                                            </ListBox.ItemTemplate>
                                        </ListBox>

                                        <Button Content="Reexecutar" Classes="PrimaryButtonStyle" Width="150" Height="36" HorizontalAlignment="Stretch" Command="{Binding RunPreflightCheckCommand}"/>
                                    </StackPanel>
                                </Border>

                                <Border Classes="ModernGroupBoxStyle">
                                    <StackPanel Margin="6" Spacing="8">
                                        <TextBlock Text="Validação SAF-T (XSD oficial AT)" Classes="SectionTitle"/>
                                        <TextBlock Text="Valide o ficheiro SAF-T selecionado de acordo com o XSD oficial publicado pela AT." TextWrapping="Wrap"/>
                                        <TextBlock Text="{Binding SaftValidationSummary}" Classes="AccentSummaryText" TextWrapping="Wrap"/>
                                        <TextBlock Text="{Binding SaftSchemaInfo}" Classes="MutedText" TextWrapping="Wrap"/>

                                        <StackPanel Spacing="8">
                                            <Button Content="Validar SAF-T"
                                                    Classes="PrimaryButtonStyle"
                                                    Width="150"
                                                    Height="36"
                                                    IsEnabled="{Binding IsSaftValidationRunning, Converter={StaticResource InverseBooleanConverter}}"
                                                    Command="{Binding ValidarSafTCommand}"/>
                                            <TextBlock Text="{Binding FicheiroSafT}" Classes="MutedText" TextWrapping="Wrap" TextTrimming="CharacterEllipsis"/>
                                        </StackPanel>

                                        <ItemsControl ItemsSource="{Binding SaftValidationSugestoes}">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <StackPanel Orientation="Horizontal" Margin="0,2,0,0">
                                                        <TextBlock Text="•" Margin="0,0,6,0" FontWeight="Bold"/>
                                                        <TextBlock Text="{Binding}" TextWrapping="Wrap" />
                                                    </StackPanel>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>

                                        <Border Classes="IssuesPanel">
                                            <ListBox ItemsSource="{Binding SaftValidationIssues}" BorderThickness="0" Background="Transparent" ScrollViewer.VerticalScrollBarVisibility="Auto" MaxHeight="240">
                                                <ListBox.ItemTemplate>
                                                    <DataTemplate>
                                                        <Border Classes="IssueItemCard">
                                                            <StackPanel>
                                                                <TextBlock Text="{Binding Resumo}" TextWrapping="Wrap" FontWeight="SemiBold" Foreground="{Binding Severidade, Converter={StaticResource SaftSeverityToColorConverter}}"/>
                                                                <TextBlock Text="{Binding Sugestao}" Margin="0,4,0,0" TextWrapping="Wrap"/>
                                                            </StackPanel>
                                                        </Border>
                                                    </DataTemplate>
                                                </ListBox.ItemTemplate>
                                            </ListBox>
                                        </Border>
                                    </StackPanel>
                                </Border>
                            </StackPanel>
                        </ScrollViewer>
                    </Grid>
                </TabItem>

                <TabItem x:Name="AjudaTab" Classes="SidebarNavItem">
                    <TabItem.Header>
                        <TextBlock Text="Ajuda"/>
                    </TabItem.Header>
                    <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="14">
                        <StackPanel Spacing="10">
                            <TextBlock Text="Como usar" Classes="HelpTitle"/>
                            <TextBlock TextWrapping="Wrap"><Bold>1. Preencha os campos obrigatórios (*)</Bold><LineBreak/>Ano, Mês, NIF, Password e Ficheiro SAF-T são obrigatórios.</TextBlock>
                            <TextBlock TextWrapping="Wrap"><Bold>2. Selecione o ficheiro SAF-T</Bold><LineBreak/>Clique no botão ... para escolher o ficheiro XML ou arquivo comprimido.</TextBlock>
                            <TextBlock TextWrapping="Wrap"><Bold>3. Configure as opções</Bold><LineBreak/>Marque "Envio de Teste" para testar sem submeter oficialmente.</TextBlock>
                            <TextBlock TextWrapping="Wrap"><Bold>4. Clique em ENVIAR</Bold><LineBreak/>O resultado aparecerá no separador "Resultado".</TextBlock>
                            <Border Classes="WarningCard" Margin="0,8,0,0">
                                <StackPanel Spacing="6">
                                    <TextBlock Text="Importante" FontWeight="Bold"/>
                                    <TextBlock TextWrapping="Wrap">Certifique-se de que todos os campos obrigatórios estão preenchidos antes de enviar.</TextBlock>
                                </StackPanel>
                            </Border>
                        </StackPanel>
                    </ScrollViewer>
                </TabItem>

                <TabItem x:Name="ResultadoTab" Classes="SidebarNavItem">
                    <TabItem.Header>
                        <TextBlock Text="Resultado"/>
                    </TabItem.Header>
                    <Grid Margin="12" RowDefinitions="Auto,*,Auto">
                        <Border Grid.Row="0" Classes="SuccessCard" Margin="0,0,0,10">
                            <TextBlock x:Name="OutputSummaryTextBlock" Text="{Binding OutputSummary}" TextWrapping="Wrap" FontSize="12"/>
                        </Border>

                        <Border Grid.Row="1" Classes="ModernGroupBoxStyle" Padding="8">
                            <ScrollViewer VerticalScrollBarVisibility="Auto">
                                <TextBox x:Name="OutputTextBlock"
                                         Text="{Binding OutputText}"
                                         IsReadOnly="True"
                                         TextWrapping="Wrap"
                                         BorderThickness="0"
                                         Background="Transparent"
                                         FontFamily="Menlo, Monaco, SF Mono, Consolas"
                                         FontSize="11"/>
                            </ScrollViewer>
                        </Border>

                        <UniformGrid Grid.Row="2" Columns="3" Margin="0,10,0,0">
                            <Button x:Name="CopiarResultadoButton" Content="Copiar" Classes="SecondaryButtonStyle" Command="{Binding CopiarResultadoCommand}" Margin="0,0,5,0" Height="38"/>
                            <Button x:Name="AbrirLogButton" Content="Abrir Log" Classes="SecondaryButtonStyle" Command="{Binding AbrirUltimoLogCommand}" Margin="0,0,5,0" Height="38"/>
                            <Button x:Name="LimparResultadoButton" Content="Limpar" Classes="SecondaryButtonStyle" Command="{Binding LimparResultadoCommand}" Height="38"/>
                        </UniformGrid>
                    </Grid>
                </TabItem>

                <TabItem x:Name="HistoricoTab" Classes="SidebarNavItem">
                    <TabItem.Header>
                        <TextBlock Text="Histórico"/>
                    </TabItem.Header>
                    <Grid Margin="12" RowDefinitions="*,Auto,Auto">
                        <Border Classes="ModernGroupBoxStyle" Grid.Row="0" Padding="8">
                            <DataGrid x:Name="HistoricoDataGrid"
                                      ItemsSource="{Binding HistoricoFiltrado}"
                                      AutoGenerateColumns="False"
                                      IsReadOnly="True"
                                      HeadersVisibility="Column"
                                      GridLinesVisibility="None"
                                      RowHeight="32">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="Data/Hora" Binding="{Binding DataHora, StringFormat=dd/MM/yyyy HH:mm}" Width="130"/>
                                    <DataGridTextColumn Header="Empresa" Binding="{Binding EmpresaNome}" Width="*"/>
                                    <DataGridTextColumn Header="Operação" Binding="{Binding Operacao}" Width="100"/>
                                    <DataGridTextColumn Header="Resultado" Binding="{Binding Resultado}" Width="100"/>
                                </DataGrid.Columns>
                            </DataGrid>
                        </Border>

                        <Border Grid.Row="1" Classes="InfoCard" Margin="0,10,0,10">
                            <TextBlock x:Name="HistoricoEstatisticasTextBlock" Text="{Binding HistoricoEstatisticas}" TextWrapping="Wrap" FontSize="12"/>
                        </Border>

                        <UniformGrid Grid.Row="2" Columns="2">
                            <Button Content="Exportar CSV" Classes="SecondaryButtonStyle" Command="{Binding ExportarHistoricoCommand}" Margin="0,0,5,0" Height="38"/>
                            <Button Content="Limpar Filtros" Classes="SecondaryButtonStyle" Command="{Binding LimparFiltrosHistoricoCommand}" Height="38"/>
                        </UniformGrid>
                    </Grid>
                </TabItem>

                <TabItem x:Name="SobreTab" Classes="SidebarNavItem">
                    <TabItem.Header>
                        <TextBlock Text="Sobre"/>
                    </TabItem.Header>
                    <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="20">
                        <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="10">
                            <Border Classes="BrandMarkWrap" Padding="12,8">
                                <Image Source="avares://EnvioSafTApp/EnviaSaft.png" Height="72"/>
                            </Border>
                            <TextBlock Text="EnvioSafT AT" FontSize="24" FontWeight="Bold" HorizontalAlignment="Center"/>
                            <TextBlock Text="{Binding AppVersion}" FontSize="14" HorizontalAlignment="Center" Classes="MutedText" Margin="0,0,0,10"/>
                            <TextBlock Text="Aplicação para envio de ficheiros SAF-T para a Autoridade Tributária"
                                       TextWrapping="Wrap"
                                       TextAlignment="Center"
                                       MaxWidth="520"/>
                            <Button Classes="SecondaryButtonStyle" Content="loadinghappiness.com" Tag="https://loadinghappiness.com" Click="Hyperlink_Click" Margin="0,8,0,0"/>
                        </StackPanel>
                    </ScrollViewer>
                </TabItem>
            </TabControl>
        </Border>

        <Border Grid.Row="2"
                x:Name="StatusTickerBorder"
                Background="{Binding TickerType, Converter={StaticResource TickerTypeToColorConverter}}"
                Padding="16,0">
            <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Spacing="10">
                <TextBlock x:Name="StatusTickerIcon"
                           Text="{Binding TickerType, Converter={StaticResource TickerTypeToIconConverter}}"
                           FontSize="16"
                           Foreground="White"
                           VerticalAlignment="Center"/>
                <TextBlock x:Name="StatusTicker"
                           Text="{Binding TickerMessage}"
                           Foreground="White"
                           FontSize="13"
                           VerticalAlignment="Center"
                           TextTrimming="CharacterEllipsis"/>
            </StackPanel>
        </Border>
    </Grid>
</Window>
